<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IHM Tacogerador (Paho MQTT)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <style>
      /* Estilização geral da página e dos componentes */
      body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        background-color: #f8f9fa; /* FUNDO CLARO */
      }
      h1, h2, h3, p, a,  .card-title {
        font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
        letter-spacing: .2px;
      }
      #dutySlider { accent-color: #dc3545; }
      #dutySlider.form-range { height: .6rem; }
      #dutySlider.form-range::-webkit-slider-runnable-track{ height: .6rem; background: #ffccd1; border-radius: 999px; }
      #dutySlider.form-range::-webkit-slider-thumb{ -webkit-appearance: none; width: 1rem; height: 1rem; border-radius: 50%; background: #dc3545; border: 2px solid #fff; box-shadow: 0 0 0 2px rgba(220,53,69,.25); margin-top: -.25rem; cursor: pointer; }
      #dutySlider.form-range:active::-webkit-slider-thumb{ box-shadow: 0 0 0 8px rgba(220,53,69,.35); }
      #dutySlider.form-range::-moz-range-track{ height: .6rem; background: #ffccd1; border-radius: 999px; }
      #dutySlider.form-range::-moz-range-thumb{ width: 1rem; height: 1rem; border-radius: 50%; background: #dc3545; border: 2px solid #fff; box-shadow: 0 0 0 6px rgba(220,53,69,.25); cursor: pointer; }
      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }
      .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
    </style>
</head>
<body> <div class="container-fluid py-3">
    <h2 class="text-center mb-4">Interface de Controle - Malha Aberta</h2>

    <div class="container mb-4">
        <div class="card shadow rounded"> <div class="card-body">
                <h3 class="h5 mb-3">Controle e Status</h3>
                <p class="mb-1">Potência (Slider): <span id="dutyValue" class="fw-bold text-danger">0</span>%</p>
                <input type="range" class="form-range mb-3" id="dutySlider" min="0" max="100" value="0">
                
                <div class="input-group mb-3">
                    <input type="number" class="form-control" placeholder="0-100" id="dutyInput" min="0" max="100">
                    <button class="btn btn-danger" type="button" id="sendButton">Enviar</button>
                </div>

                <div class="btn-group w-100 mb-4" role="group">
                    <button type="button" class="btn btn-outline-dark" id="btn_0">Parar (0%)</button>
                    <button type="button" class="btn btn-outline-dark" id="btn_50">Médio (50%)</button>
                    <button type="button" class="btn btn-outline-dark" id="btn_100">Máximo (100%)</button>
                </div>
                
                <p class="mb-1">Status da Conexão: <span id="status" class="fw-bold text-warning">Desconectado</span></p>
                <hr class="my-2">
                <h4 class="h6">Leituras Atuais:</h4>
                <p class="mb-0">Duty Cycle Enviado: <span id="currentDuty" class="fw-bold">--</span> %</p>
                <p class="mb-0">Tensão do Tacogerador: <span id="currentTacho" class="fw-bold">--</span> V</p>
                
                <div class="btn-group w-100 mt-3" role="group">
                    <button class="btn btn-outline-warning btn-sm" id="resetButton">Resetar Gráficos</button>
                    <button class="btn btn-outline-success btn-sm" id="saveButton">Salvar Dados CSV</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow rounded h-100"> <div class="card-body">
                        <h3 class="h5 mb-3">Sinal de Controle (Duty Cycle)</h3>
                        <div class="chart-container">
                            <canvas id="chartInput"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow rounded h-100"> <div class="card-body">
                        <h3 class="h5 mb-3">Resposta do Sistema (Tensão)</h3>
                        <div class="chart-container">
                            <canvas id="chartOutput"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LÓGICA DO PAHO MQTT ---
    const options = { host: '10.199.205.38', port: 1883, clientId: 'IHM_Tacogerador_' + parseInt(Math.random() * 100) };
    const client = new Paho.MQTT.Client(options.host, Number(options.port), "/mqtt", options.clientId);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.connect({ onSuccess: onConnect, onFailure: onFailure, useSSL: false });

    // --- ELEMENTOS E FUNÇÕES DA PÁGINA ---
    const dutySlider = document.getElementById('dutySlider');
    const dutyValueSpan = document.getElementById('dutyValue');
    const statusSpan = document.getElementById('status');
    const dutyInput = document.getElementById('dutyInput');
    const sendButton = document.getElementById('sendButton');
    const btn0 = document.getElementById('btn_0');
    const btn50 = document.getElementById('btn_50');
    const btn100 = document.getElementById('btn_100');
    const currentDutySpan = document.getElementById('currentDuty');
    const currentTachoSpan = document.getElementById('currentTacho');
    const resetButton = document.getElementById('resetButton');
    const saveButton = document.getElementById('saveButton');
    const ctxInput = document.getElementById("chartInput").getContext("2d");
    const ctxOutput = document.getElementById("chartOutput").getContext("2d");

    // --- VARIÁVEIS DE CONTROLE ---
    const ts = 0.01;
    let current_time = 0;
    let lastSendTime = 0;
    const SEND_INTERVAL = 50;
    const chartData = { time: [], duty: [], tacho: [] };
    let lastDutyValue = 0;
    let lastTachoValue = 0;
    
    // ✅ CORES DO GRÁFICO ALTERADAS PARA TEMA CLARO
    Chart.defaults.color = '#495057';
    Chart.defaults.borderColor = 'rgba(0,0,0,.1)';

    function setStatus(texto, bsClass) {
        statusSpan.textContent = texto;
        statusSpan.classList.remove('text-success', 'text-danger', 'text-warning');
        statusSpan.classList.add(bsClass);
    }
    function onConnect() {
        console.log("Conectado ao Broker MQTT com sucesso!");
        setStatus("Conectado", "text-success");
        client.subscribe("ESP32/INPUT");
        client.subscribe("ESP32/TACO_BLOCK");
        startChartAnimation();
    }
    function onFailure(response) {
        console.error("Falha ao conectar:", response.errorMessage);
        setStatus("Falha na Conexão", "text-danger");
    }
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Conexão perdida:", responseObject.errorMessage);
            setStatus("Desconectado", "text-warning");
        }
    }
    function onMessageArrived(message) {
        const topic = message.destinationName;
        const msg = message.payloadString.trim();
        if (topic === "ESP32/INPUT" && msg.startsWith("DUTY,")) {
            const duty = parseInt(msg.split(",")[1]);
            if (!isNaN(duty)) {
                lastDutyValue = duty;
                currentDutySpan.textContent = duty;
            }
        }
        else if (topic === "ESP32/TACO_BLOCK") {
            const valores = msg.split(',');
            valores.forEach(valor_str => {
                const valor_num = parseFloat(valor_str);
                if (!isNaN(valor_num)) {
                    lastTachoValue = valor_num;
                }
            });
            currentTachoSpan.textContent = lastTachoValue.toFixed(2);
        }
    }
    function setDutyAndSend(duty) {
        duty = Math.max(0, Math.min(100, parseInt(duty)));
        if (isNaN(duty)) duty = 0;
        dutySlider.value = duty;
        dutyValueSpan.textContent = duty;
        dutyInput.value = duty;
        sendMqttCommand(duty);
    }
    function sendMqttCommand(dutyValue) {
        if (client.isConnected()) {
            const messageText = `SET_DUTY=${dutyValue}`;
            const message = new Paho.MQTT.Message(messageText);
            message.destinationName = "ESP32/COMMAND";
            client.send(message);
            console.log(`Comando enviado: ${messageText}`);
        } else {
            console.warn("Não foi possível enviar, cliente MQTT desconectado.");
        }
    }
    function saveDataToCSV() {
        if (chartData.time.length === 0) {
            alert('Não há dados para salvar!');
            return;
        }
        let csvContent = "Tempo(s),Duty_Cycle(%),Tensao_Taco(V)\n";
        for (let i = 0; i < chartData.time.length; i++) {
            csvContent += `${chartData.time[i].toFixed(3)},${chartData.duty[i] || 0},${(chartData.tacho[i] || 0).toFixed(3)}\n`;
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const filename = `dados_tacogerador_${timestamp}.csv`;
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert(`Dados salvos com sucesso!\nArquivo: ${filename}`);
    }
    function resetCharts() {
        current_time = 0;
        chartData.time = [];
        chartData.duty = [];
        chartData.tacho = [];
        lastDutyValue = 0;
        lastTachoValue = 0;
        chartInput.update();
        chartOutput.update();
        console.log('Gráficos resetados');
    }

    // --- LÓGICA DOS GRÁFICOS ---
    function startChartAnimation() {
        function animate() {
            chartData.time.push(parseFloat(current_time.toFixed(2)));
            chartData.duty.push(lastDutyValue);
            chartData.tacho.push(lastTachoValue);
            if (chartData.time.length > (20 / ts)) {
                chartData.time.shift();
                chartData.duty.shift();
                chartData.tacho.shift();
            }
            const min = chartData.time.length > 0 ? chartData.time[0] : 0;
            const max = chartData.time.length > 0 ? chartData.time[chartData.time.length - 1] : 5;
            chartInput.options.scales.x.min = min;
            chartInput.options.scales.x.max = max;
            chartOutput.options.scales.x.min = min;
            chartOutput.options.scales.x.max = max;
            chartInput.update('none');
            chartOutput.update('none');
            current_time += ts;
            requestAnimationFrame(animate);
        }
        animate();
    }
    const chartConfig = (label, color, yMax, yText) => ({
        type: "line",
        data: {
            labels: chartData.time,
            datasets: [{
                label: label,
                data: (label.includes("Duty") ? chartData.duty : chartData.tacho),
                borderColor: color,
                tension: 0.9,
                pointRadius: 0,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                x: {
                    type: 'linear',
                    display: true,
                    title: { display: true, text: 'Tempo [s]' },
                    grid: { color: 'rgba(0,0,0,0.1)' }, // ✅ COR DA GRADE ALTERADA
                    ticks: {
                        stepSize: 1,
                        callback: function(value, index, ticks) {
                            if (index === 0 || index === ticks.length - 1) { return Math.round(value); }
                            if (Number.isInteger(value)) { return value; }
                            return null;
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    max: yMax,
                    title: { display: true, text: yText },
                    grid: { color: 'rgba(0,0,0,0.1)' } // ✅ COR DA GRADE ALTERADA
                }
            }
        }
    });
    const chartInput = new Chart(ctxInput, chartConfig("Duty Cycle (%)", "#6ea5f7", 100, "Duty Cycle [%]"));
    const chartOutput = new Chart(ctxOutput, chartConfig("Tensão Taco (V)", "#dc3545", 3.0, "Tensão [V]"));

    // --- EVENT LISTENERS ---
    dutySlider.addEventListener('input', () => {
        const duty = dutySlider.value;
        dutyValueSpan.textContent = duty;
        dutyInput.value = duty;
        const now = Date.now();
        if (now - lastSendTime > SEND_INTERVAL) {
            sendMqttCommand(duty);
            lastSendTime = now;
        }
    });
    dutySlider.addEventListener('change', () => sendMqttCommand(dutySlider.value));
    sendButton.addEventListener('click', () => setDutyAndSend(dutyInput.value));
    btn0.addEventListener('click', () => setDutyAndSend(0));
    btn50.addEventListener('click', () => setDutyAndSend(50));
    btn100.addEventListener('click', () => setDutyAndSend(100));
    resetButton.addEventListener('click', resetCharts);
    saveButton.addEventListener('click', saveDataToCSV);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
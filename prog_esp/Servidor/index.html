<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IHM Tacogerador (Paho MQTT)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      }
      h1, h2, h3, p, a,  .card-title {
        font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
        letter-spacing: .2px;
      }
      #dutySlider { accent-color: #dc3545; }
      #dutySlider.form-range { height: .6rem; }
      #dutySlider.form-range::-webkit-slider-runnable-track{
        height: .6rem;
        background: #ffccd1;/* trilho em vermelho claro */
        border-radius: 999px;
      }
      #dutySlider.form-range::-webkit-slider-thumb{
        -webkit-appearance: none;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #dc3545; /* bolinha vermelha */
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px rgba(220,53,69,.25); /* anel suave */
        margin-top: -.25rem;
        cursor: pointer;
      }
      #dutySlider.form-range:active::-webkit-slider-thumb{
        box-shadow: 0 0 0 8px rgba(220,53,69,.35);
      }

      /* ===== Firefox ===== */
      #dutySlider.form-range::-moz-range-track{
        height: .6rem;
        background: #ffccd1;
        border-radius: 999px;
      }
      #dutySlider.form-range::-moz-range-thumb{
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #dc3545;
        border: 2px solid #fff;
        box-shadow: 0 0 0 6px rgba(220,53,69,.25);
        cursor: pointer;
      }
  </style>
</head>
<body class="bg-secondary text-white">
<div class="container-fluid py-2">
    <h2 class="text-left mb-4 px-3">IHM Tacogerador - Entrada x Saída</h2>
    <div class="container mb-3">
      <div class="card bg-dark bg-opacity-50 text-white shadow rounded h-100">
        <div class="card-body">
          <h3 class="h5 mb-3">Controle de Entrada (Enviar Duty Cycle)</h3>
          <input type="range" class="form-range mb-3" id="dutySlider" min="0" max="100" value="0" >
          <p>Valor a ser enviado: <span id="dutyValue" class="fw-bold text-danger">0</span>%</p>
          <p>Status da Conexão: 
            <span id="status" class="fw-bold text-warning">Desconectado</span>
          </p>
        </div>
      </div>
    </div>

    <div class="container">
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card bg-dark bg-opacity-50 text-white shadow rounded h-100">
        <div class="card-body">
          <h3 class="h5 mb-3">Gráfico de Entrada (Duty Cycle %)</h3>
          <canvas id="chartInput"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card bg-dark bg-opacity-50 text-white shadow rounded h-100">
        <div class="card-body">
          <h3 class="h5 mb-3">Gráfico de Saída (Tensão Taco - Volts)</h3>
          <canvas id="chartOutput"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

  </div>
  <script>
    // --- INÍCIO DO SCRIPT CORRIGIDO E INTEGRADO ---

    // Referências aos elementos HTML
    const ctxInput = document.getElementById("chartInput").getContext("2d");
    const ctxOutput = document.getElementById("chartOutput").getContext("2d");
    const dutySlider = document.getElementById('dutySlider');
    const dutyValueSpan = document.getElementById('dutyValue');
    const statusSpan = document.getElementById('status');

    // Configurações globais para os gráficos terem texto branco
    Chart.defaults.color = '#dee2e6';
    Chart.defaults.borderColor = 'rgba(222,226,239,.15)';
    
    // --- LÓGICA DO PAHO MQTT ---

    const options = {
        host: '172.20.10.2', // <-- SEU IP AQUI
        port: 1883,
        clientId: 'IHM_Tacogerador_' + parseInt(Math.random() * 100)
    };

    const client = new Paho.MQTT.Client(options.host, Number(options.port), "/mqtt", options.clientId);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.connect({
        onSuccess: onConnect,
        onFailure: onFailure,
        useSSL: false
    });

    // Função para atualizar o status na tela (sua ótima ideia)
    function setStatus(texto, bsClass) {
      statusSpan.textContent = texto;
      statusSpan.classList.remove('text-success', 'text-danger', 'text-warning');
      statusSpan.classList.add(bsClass);
    }

    function onConnect() {
      console.log("Conectado ao Broker MQTT com sucesso!");
      setStatus("Conectado", "text-success");
      client.subscribe("ESP32/COMMAND");  // Para enviar comandos
      client.subscribe("ESP32/INPUT");    // Para receber feedback do duty
      client.subscribe("ESP32/TACO_BLOCK"); // Para receber os dados do taco em bloco
    }

    function onFailure(response) {
      console.error("Falha ao conectar:", response.errorMessage);
      setStatus("Falha na Conexão", "text-danger");
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("Conexão perdida:", responseObject.errorMessage);
        setStatus("Desconectado", "text-warning");
      }
    }

    // Função para receber mensagens (atualizada para dados em bloco)
    function onMessageArrived(message) {
      const topic = message.destinationName;
      const msg = message.payloadString.trim();

      // CORRIGIDO: Adicionado ` (crase) para o log funcionar
      console.log(Mensagem recebida no tópico [${topic}]);

      if (topic === "ESP32/INPUT" && msg.startsWith("DUTY,")) {
        const duty = parseInt(msg.split(",")[1]);
        if (!isNaN(duty)) updateChart(chartInput, duty);
      } 
      // LÓGICA ATUALIZADA para "desempacotar" o bloco de dados
      else if (topic === "ESP32/TACO_BLOCK") {
          const valores = msg.split(','); // Quebra a string em um array
          valores.forEach(valor_str => {
              const valor_num = parseFloat(valor_str);
              if (!isNaN(valor_num)) {
                  updateChart(chartOutput, valor_num); // Plota cada valor
              }
          });
      }
    }
    
    // Função para enviar comandos via MQTT
    function sendMqttCommand(dutyValue) {
      if (client.isConnected()) {
        // CORRIGIDO: Adicionado ` (crase) para a mensagem funcionar
        const message = new Paho.MQTT.Message(SET_DUTY,${dutyValue});
        message.destinationName = "ESP32/COMMAND";
        client.send(message);
        // CORRIGIDO: Adicionado ` (crase) para o log funcionar
        console.log(Comando enviado: SET_DUTY,${dutyValue});
      } else {
        console.warn("Não foi possível enviar, cliente MQTT desconectado.");
      }
    }

    // Evento do slider
    dutySlider.addEventListener('input', () => {
      const duty = dutySlider.value;
      dutyValueSpan.textContent = duty;
      sendMqttCommand(duty);
    });

    // --- CÓDIGO DE INICIALIZAÇÃO DOS GRÁFICOS (APENAS UMA VEZ) ---
    const chartInput = new Chart(ctxInput, {
      type: "line",
      data: { labels: [], datasets: [{ label: "Duty (%)", data: [], borderColor: "#6ea5f7" }] },
      options: { responsive: true, animation: false, scales: { x: { display: false }, y: { beginAtZero: true, max: 100 } } }
    });

    const chartOutput = new Chart(ctxOutput, {
      type: "line",
      data: { labels: [], datasets: [{ label: "Taco (V)", data: [], borderColor: "#dc3545" }] }, // Cor vermelha para combinar
      options: { responsive: true, animation: false, scales: { x: { display: false }, y: { beginAtZero: true, max: 3.3 } } }
    });

    function updateChart(chart, value) {
      chart.data.labels.push(new Date().toLocaleTimeString());
      chart.data.datasets[0].data.push(value);
      if (chart.data.labels.length > 200) { // Histórico um pouco maior para os blocos
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update("none");
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>